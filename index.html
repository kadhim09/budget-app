<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>برنامج تقسيم الراتب وإدارة المصاريف</title>
  <style>
    body { font-family: system-ui, Arial; margin: 18px; line-height: 1.6; }
    .wrap { max-width: 980px; margin: auto; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 12px; }
    h2,h3 { margin: 0 0 10px; }
    .muted { color: #666; font-size: 13px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 14px; margin-bottom: 6px; }
    input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    input[readonly] { background:#f7f7f7; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #999; background: #f6f6f6; cursor: pointer; }
    .row { display: flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px dashed #eee; }
    .row:last-child { border-bottom: 0; }
    .ok { font-weight: 700; }
    .warn { font-weight: 700; color: #b00020; }
    .btns { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    .line { border: none; border-top: 1px solid #eee; margin: 14px 0; }
    .expense-row { display:grid; grid-template-columns: 1.2fr 1fr auto; gap:10px; align-items:end; }
    .expense-row .remove { padding: 10px 12px; }
    @media (max-width: 760px) {
      .grid, .grid3 { grid-template-columns: 1fr; }
      .expense-row { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h2>إدارة الدخل والمصاريف</h2>
    <div class="muted">الدخل الكلي يُحسب تلقائيًا، وكل المصاريف تُخصم منه. (سحب الاحتياط لا يؤثر على الدخل)</div>
  </div>


  <div class="card" id="monthCard">
    <h3>إدارة الشهور والنسخ الاحتياطي</h3>

    <div>
      <label>الشهر</label>
      <input id="monthKey" type="month">
      <div class="muted">كل شهر ينحفظ وحده. عند تبديل الشهر أو بدء شهر جديد، راح ينخزن الشهر السابق تلقائيًا.</div>
    </div>

    <div style="margin-top:10px">
      <label>إجراءات</label>
      <div class="btns" style="margin-top:0">
        <button type="button" onclick="saveMonth()">حفظ هذا الشهر</button>
        <button type="button" onclick="loadMonth()">تحميل هذا الشهر</button>
        <button type="button" onclick="startNewMonth()">بدء شهر جديد</button>
        <button type="button" onclick="exportBackup()">تصدير نسخة احتياطية</button>
        <button type="button" onclick="triggerImport()">استيراد نسخة</button>
        <button type="button" onclick="clearAllData()">مسح كل البيانات</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <div class="muted">ملاحظة: الادخار/الاحتياط (الرصيد الحالي) يبقى متراكم لكل الشهور، أما "إضافة هذا الشهر" تنحفظ ضمن الشهر.</div>
    </div>
  </div>
      <div>
        <label>إجراءات</label>
        <div class="btns" style="margin-top:0">
          <button type="button" onclick="saveMonth()">حفظ هذا الشهر</button>
          <button type="button" onclick="loadMonth()">تحميل هذا الشهر</button>
          <button type="button" onclick="startNewMonth()">بدء شهر جديد</button>
          <button type="button" onclick="exportBackup()">تصدير نسخة احتياطية</button>
          <button type="button" onclick="triggerImport()">استيراد نسخة</button>
          <button type="button" onclick="clearAllData()">مسح كل البيانات</button>
        </div>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <div class="muted">ملاحظة: الادخار/الاحتياط (الرصيد الحالي) يبقى متراكم لكل الشهور، أما "إضافة هذا الشهر" تنحفظ ضمن الشهر.</div>
      </div>
    </div>
  </div>


  <!-- الدخل -->
  <div class="card">
    <h3>الدخل</h3>
    <div class="grid">
      <div>
        <label>الراتب الأول</label>
        <input id="salary1" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>الراتب الثاني</label>
        <input id="salary2" type="number" value="" min="" step="1000">
      </div>
    </div>

    <div style="margin-top:10px" class="grid">
      <div>
        <label>الدخل الكلي</label>
        <input id="totalIncome" type="text" readonly>
      </div>
      <div class="muted">هذا الرقم هو الأساس الذي تُخصم منه المصاريف.</div>
    </div>
  </div>

  <!-- مصاريف تعليم -->
  <div class="card">
    <h3>مصاريف تعليم</h3>
    <div class="grid">
      <div>
        <label>مصاريف روضة</label>
        <input id="nursery" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>مصاريف مدرسة</label>
        <input id="school" type="number" value="" min="" step="1000">
      </div>
    </div>
  </div>

  <!-- طفل جديد -->
  <div class="card">
    <h3>مصاريف طفل جديد</h3>
    <div class="grid3">
      <div>
        <label>ملابس</label>
        <input id="babyClothes" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>حليب</label>
        <input id="babyMilk" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>حفاظات</label>
        <input id="babyDiapers" type="number" value="" min="" step="1000">
      </div>
    </div>
  </div>

  <!-- مصاريف ثابتة -->
  <div class="card">
    <h3>مصاريف عامة (ثابتة)</h3>
    <div class="grid">
      <div>
        <label>مصاريف رصيد</label>
        <input id="phone" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>مصاريف بيت</label>
        <input id="home" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>مصاريف ثانوية</label>
        <input id="secondary" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>حقل إضافي (أي مصروف آخر)</label>
        <input id="other" type="number" value="" min="" step="1000">
      </div>
    </div>

    <hr class="line">

    <h3 style="margin-top:0">مصاريف إضافية (تضيفها أنت)</h3>
    <div class="muted">اضغط "إضافة مصروف" حتى تضيف سطر جديد باسم ومبلغ. هذا المبلغ ينخصم من الدخل الكلي.</div>

    <div id="extraExpenses"></div>

    <div class="btns">
      <button type="button" onclick="addExpenseRow()">إضافة مصروف</button>
      <button type="button" onclick="clearExtraExpenses()">مسح المصاريف الإضافية</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div>مجموع المصاريف الإضافية</div>
      <div class="ok" id="extraTotal">-</div>
    </div>
  </div>

  <!-- ادخار واحتياط -->
  <div class="card">
    <h3>الادخار والاحتياط (تراكم)</h3>

    <div class="grid">
      <div>
        <label>ادخار: الرصيد الحالي (يتراكم)</label>
        <input id="savingsBalance" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>ادخار: إضافة هذا الشهر</label>
        <input id="savingsAdd" type="number" value="" min="" step="1000">
        <div class="btns">
          <button type="button" onclick="applySavings()">أضف إلى الادخار</button>
          <button type="button" onclick="resetSavingsAdd()">تصفير إضافة الادخار</button>
        </div>
      </div>
    </div>

    <hr class="line">

    <div class="grid">
      <div>
        <label>احتياط: الرصيد الحالي (يتراكم)</label>
        <input id="reserveBalance" type="number" value="" min="" step="1000">
      </div>
      <div>
        <label>احتياط: إضافة هذا الشهر</label>
        <input id="reserveAdd" type="number" value="" min="" step="1000">
        <div class="btns">
          <button type="button" onclick="applyReserve()">أضف إلى الاحتياط</button>
          <button type="button" onclick="resetReserveAdd()">تصفير إضافة الاحتياط</button>
        </div>
      </div>
    </div>

    <hr class="line">

    <!-- سحب من الاحتياط -->
    <div class="grid">
      <div>
        <label>سحب من الاحتياط (لا يؤثر على الدخل الكلي)</label>
        <input id="reserveWithdraw" type="number" value="" min="" step="1000">
        <div class="btns">
          <button type="button" onclick="withdrawReserve()">سحب</button>
          <button type="button" onclick="resetReserveWithdraw()">تصفير السحب</button>
        </div>
      </div>
      <div class="muted">
        هذا السحب ينقص من رصيد الاحتياط المتراكم فقط، ولا يدخل ضمن المصاريف الشهرية.
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>رصيد الاحتياط الحالي بعد السحب/الإضافة</div>
      <div class="ok" id="reserveDisplay">-</div>
    </div>

    <div class="muted" style="margin-top:10px">
      تنبيه: "إضافة هذا الشهر" للادخار/الاحتياط تُحسب ضمن المصاريف لأنها تُخصم من الدخل الكلي. أما "سحب من الاحتياط" لا علاقة له بالدخل.
    </div>
  </div>

  <!-- النتائج -->
  <div class="card">
    <h3>النتائج</h3>
    <div class="row"><div>الدخل الكلي</div><div class="ok" id="r_income">-</div></div>
    <div class="row"><div>إجمالي المصاريف (يشمل ادخار/احتياط الشهري + المصاريف الإضافية)</div><div class="ok" id="r_expenses">-</div></div>
    <div class="row"><div>الباقي بعد كل المصاريف</div><div id="r_left">-</div></div>
    <div class="row"><div>نسبة المصاريف من الدخل</div><div id="r_ratio">-</div></div>
  </div>

</div>

<script>
  // ===== أدوات عامة =====
  const el = (id) => document.getElementById(id);
  function nVal(input){ return Number(input?.value) || 0; }
  function n(id){ return Number(el(id)?.value) || 0; }
  function setVal(id, v){ if(el(id)) el(id).value = (v ?? ""); }
  function fmt(v){
    const x = Math.round(Number(v) || 0);
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " د.ع";
  }

  // ===== تخزين =====
  const STORE_KEY = "budget_monthly_store_v1";

  function loadStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return { global: { savingsBalance: 0, reserveBalance: 0 }, months: {} };
      const s = JSON.parse(raw);
      if(!s || typeof s !== "object") throw new Error("bad store");
      s.global = s.global || { savingsBalance: 0, reserveBalance: 0 };
      s.months = s.months || {};
      return s;
    }catch(e){
      return { global: { savingsBalance: 0, reserveBalance: 0 }, months: {} };
    }
  }

  function saveStore(store){
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
  }

  function getThisMonth(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${d.getFullYear()}-${mm}`;
  }

  function currentMonthKey(){
    const v = el("monthKey")?.value;
    return v && /^\d{4}-\d{2}$/.test(v) ? v : getThisMonth();
  }

  function monthPlusOne(ym){
    const [y,m] = ym.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()+1);
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${d.getFullYear()}-${mm}`;
  }

  // ===== مصاريف إضافية ديناميكية =====
  function addExpenseRow(nameVal="", amountVal=0){
    const wrap = el("extraExpenses");

    const row = document.createElement("div");
    row.className = "expense-row";
    row.style.marginTop = "10px";

    const nameBox = document.createElement("div");
    const nameLabel = document.createElement("label");
    nameLabel.textContent = "اسم المصروف";
    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "مثال: صيانة / علاج / ملابس";
    nameInput.value = nameVal || "";
    nameInput.addEventListener("input", () => scheduleSaveAndCalc());
    nameBox.appendChild(nameLabel);
    nameBox.appendChild(nameInput);

    const amountBox = document.createElement("div");
    const amountLabel = document.createElement("label");
    amountLabel.textContent = "المبلغ";
    const amountInput = document.createElement("input");
    amountInput.type = "number";
    amountInput.min = "0";
    amountInput.step = "1000";
    amountInput.value = String(amountVal || 0);
    amountInput.addEventListener("input", () => scheduleSaveAndCalc());
    amountBox.appendChild(amountLabel);
    amountBox.appendChild(amountInput);

    const btnBox = document.createElement("div");
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "remove";
    removeBtn.textContent = "حذف";
    removeBtn.addEventListener("click", () => {
      row.remove();
      scheduleSaveAndCalc(true);
    });
    btnBox.appendChild(removeBtn);

    row._nameInput = nameInput;
    row._amountInput = amountInput;

    row.appendChild(nameBox);
    row.appendChild(amountBox);
    row.appendChild(btnBox);
    wrap.appendChild(row);
  }

  function getExtraExpensesList(){
    const rows = el("extraExpenses")?.querySelectorAll(".expense-row") || [];
    const list = [];
    rows.forEach(r => {
      list.push({
        name: (r._nameInput?.value || "").trim(),
        amount: nVal(r._amountInput)
      });
    });
    return list;
  }

  function getExtraExpensesTotal(){
    return getExtraExpensesList().reduce((a,b)=>a+(Number(b.amount)||0), 0);
  }

  function clearExtraExpenses(){
    el("extraExpenses").innerHTML = "";
    scheduleSaveAndCalc(true);
  }

  // ===== الحساب الرئيسي =====
  function calc(){
    const income = n("salary1") + n("salary2");
    el("totalIncome").value = fmt(income);

    const edu = n("nursery") + n("school");
    const baby = n("babyClothes") + n("babyMilk") + n("babyDiapers");
    const general = n("phone") + n("home") + n("secondary") + n("other");

    // ادخار/احتياط الشهري (إضافة هذا الشهر) تدخل ضمن المصاريف
    const monthlySavings = n("savingsAdd");
    const monthlyReserve = n("reserveAdd");

    const extra = getExtraExpensesTotal();
    el("extraTotal").textContent = fmt(extra);

    const expenses = edu + baby + general + monthlySavings + monthlyReserve + extra;
    const left = income - expenses;

    el("r_income").textContent = fmt(income);
    el("r_expenses").textContent = fmt(expenses);

    const leftEl = el("r_left");
    leftEl.textContent = fmt(left);
    leftEl.className = (left >= 0) ? "ok" : "warn";

    const ratio = income > 0 ? (expenses / income) * 100 : 0;
    el("r_ratio").textContent = ratio.toFixed(1) + "%";

    el("reserveDisplay").textContent = fmt(n("reserveBalance"));
  }

  // ===== تراكم الادخار =====
  function applySavings(){
    const add = n("savingsAdd");
    if(add <= 0) return;
    setVal("savingsBalance", n("savingsBalance") + add);
    setVal("savingsAdd", 0);
    scheduleSaveAndCalc(true);
  }
  function resetSavingsAdd(){
    setVal("savingsAdd", 0);
    scheduleSaveAndCalc(true);
  }

  // ===== تراكم الاحتياط =====
  function applyReserve(){
    const add = n("reserveAdd");
    if(add <= 0) return;
    setVal("reserveBalance", n("reserveBalance") + add);
    setVal("reserveAdd", 0);
    scheduleSaveAndCalc(true);
  }
  function resetReserveAdd(){
    setVal("reserveAdd", 0);
    scheduleSaveAndCalc(true);
  }

  // ===== سحب من الاحتياط (لا يؤثر على الدخل) =====
  function withdrawReserve(){
    const w = n("reserveWithdraw");
    if(w <= 0) return;

    const current = n("reserveBalance");
    const newBal = current - w;

    if(newBal < 0){
      alert("المبلغ أكبر من رصيد الاحتياط الحالي.");
      return;
    }

    setVal("reserveBalance", newBal);
    setVal("reserveWithdraw", 0);
    scheduleSaveAndCalc(true);
  }
  function resetReserveWithdraw(){
    setVal("reserveWithdraw", 0);
    scheduleSaveAndCalc(true);
  }

  // ===== الشهرية =====
  const MONTH_FIELDS = [
    "salary1","salary2",
    "nursery","school",
    "babyClothes","babyMilk","babyDiapers",
    "phone","home","secondary","other",
    "savingsAdd","reserveAdd"
  ];

  function getMonthSummary(){
    const income = n("salary1") + n("salary2");
    const edu = n("nursery") + n("school");
    const baby = n("babyClothes") + n("babyMilk") + n("babyDiapers");
    const general = n("phone") + n("home") + n("secondary") + n("other");
    const extra = getExtraExpensesTotal();
    const expenses = edu + baby + general + n("savingsAdd") + n("reserveAdd") + extra;
    return { income, expenses, left: income-expenses };
  }

  function captureMonth(){
    const data = {};
    MONTH_FIELDS.forEach(id => data[id] = n(id));
    data.extraExpenses = getExtraExpensesList();
    data.savedAt = new Date().toISOString();
    data.summary = getMonthSummary();
    return data;
  }

  function applyMonthData(data){
    MONTH_FIELDS.forEach(id => setVal(id, (data?.[id] ?? 0)));
    el("extraExpenses").innerHTML = "";
    (data?.extraExpenses || []).forEach(x => addExpenseRow(x.name || "", Number(x.amount)||0));
    setVal("reserveWithdraw", 0);
    calc();
  }

  function clearMonthForm(){
    MONTH_FIELDS.forEach(id => setVal(id, 0));
    el("extraExpenses").innerHTML = "";
    setVal("reserveWithdraw", 0);
    calc();
  }

  function saveMonthInternal(monthKey){
    const store = loadStore();
    store.global.savingsBalance = n("savingsBalance");
    store.global.reserveBalance = n("reserveBalance");
    store.months[monthKey] = captureMonth();
    store._lastMonthKey = monthKey;
    saveStore(store);
  }

  function loadMonthInternal(monthKey){
    const store = loadStore();
    setVal("savingsBalance", store.global?.savingsBalance ?? 0);
    setVal("reserveBalance", store.global?.reserveBalance ?? 0);

    if(store.months && store.months[monthKey]){
      applyMonthData(store.months[monthKey]);
    }else{
      clearMonthForm();
    }
    calc();
  }

  function saveMonth(){
    const mk = currentMonthKey();
    saveMonthInternal(mk);
    alert("تم حفظ الشهر: " + mk);
  }

  function loadMonth(){
    const mk = currentMonthKey();
    loadMonthInternal(mk);
    alert("تم تحميل الشهر: " + mk);
  }

  function startNewMonth(){
    const mk = currentMonthKey();
    // احفظ الشهر الحالي قبل الانتقال
    saveMonthInternal(mk);

    const next = monthPlusOne(mk);
    el("monthKey").value = next;

    // ابدأ شهر جديد: صفّر حقول الشهر فقط، وخلي الرصيد المتراكم مثل ما هو
    clearMonthForm();
    setVal("savingsAdd", 0);
    setVal("reserveAdd", 0);

    // خزّن فوري الشهر الجديد كقالب فارغ
    saveMonthInternal(next);
    alert("تم بدء شهر جديد: " + next);
  }

  // ===== حفظ تلقائي =====
  let saveTimer = null;
  function scheduleSaveAndCalc(immediate=false){
    calc();
    if(immediate){
      autoSaveNow();
      return;
    }
    clearTimeout(saveTimer);
    saveTimer = setTimeout(autoSaveNow, 350);
  }

  function autoSaveNow(){
    const mk = currentMonthKey();
    saveMonthInternal(mk);
  }

  function onMonthChange(){
    const store = loadStore();
    const prev = store._lastMonthKey || getThisMonth();
    // حفظ الشهر السابق قبل التحميل
    saveMonthInternal(prev);

    const mk = currentMonthKey();
    loadMonthInternal(mk);

    const s2 = loadStore();
    s2._lastMonthKey = mk;
    saveStore(s2);
  }

  // ===== نسخ احتياطي =====
  function exportBackup(){
    const mk = currentMonthKey();
    saveMonthInternal(mk);
    const store = loadStore();

    const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "budget-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function triggerImport(){
    el("importFile").click();
  }

  function handleImportFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(String(reader.result || ""));
        if(!parsed || typeof parsed !== "object") throw new Error("invalid json");
        if(!parsed.months || !parsed.global) throw new Error("missing keys");
        localStorage.setItem(STORE_KEY, JSON.stringify(parsed));
        const mk = currentMonthKey();
        const s = loadStore();
        s._lastMonthKey = mk;
        saveStore(s);
        loadMonthInternal(mk);
        alert("تم استيراد النسخة بنجاح.");
      }catch(e){
        alert("فشل الاستيراد: الملف غير صحيح.");
      }
    };
    reader.readAsText(file);
  }

  function clearAllData(){
    if(!confirm("تأكيد: مسح كل البيانات (الشهور + الادخار/الاحتياط + كل شيء)؟")) return;
    localStorage.removeItem(STORE_KEY);
    init();
  }

  // ===== تهيئة =====
  function init(){
    el("monthKey").value = getThisMonth();

    const store = loadStore();
    if(!store._lastMonthKey) store._lastMonthKey = el("monthKey").value;
    saveStore(store);

    loadMonthInternal(currentMonthKey());

    const ids = [
      ...MONTH_FIELDS,
      "savingsBalance","reserveBalance",
      "reserveWithdraw"
    ];
    ids.forEach(id => el(id)?.addEventListener("input", () => scheduleSaveAndCalc(false)));

    el("monthKey").addEventListener("change", onMonthChange);

    el("importFile").addEventListener("change", (e) => {
      const f = e.target.files && e.target.files[0];
      if(f) handleImportFile(f);
      e.target.value = "";
    });

    scheduleSaveAndCalc(true);
  }

  init();

  // ===== إتاحة الدوال للأزرار =====
  window.addExpenseRow = addExpenseRow;
  window.clearExtraExpenses = clearExtraExpenses;

  window.applySavings = applySavings;
  window.resetSavingsAdd = resetSavingsAdd;

  window.applyReserve = applyReserve;
  window.resetReserveAdd = resetReserveAdd;

  window.withdrawReserve = withdrawReserve;
  window.resetReserveWithdraw = resetReserveWithdraw;

  window.saveMonth = saveMonth;
  window.loadMonth = loadMonth;
  window.startNewMonth = startNewMonth;

  window.exportBackup = exportBackup;
  window.triggerImport = triggerImport;
  window.clearAllData = clearAllData;
</script>

</body>
</html>
